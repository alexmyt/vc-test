### Автоматизация управления версией проекта
Один из вариантов облегчения изменения версии проекта в файле `package.json`

#### Исходные условия
Работа с ветками ведется по принципам упрощенного GitFlow: существует главная релизная ветка `main`, промежуточная ветка для разработки `develop` и фича-ветки. Отдельные ветки под каждый новый релиз не создаются.

#### В чем проблема?
* Необходимо автоматизировать инкремент версии проекта (свойство `version` в файле `package.json`)
* Необходимо упростить публикацию новых версий проекта.

#### Один из вариантов решения - [changesets](https://github.com/changesets/changesets)
После внедрения этого варианта процесс разработки и деплоя может выглядеть так:
1. Для разработки новой фичи или багфикса разработчик создает новую фича-ветку от ветки `develop`.
2. В новой ветке командой `npx changeset` создается файл с типом (patch, minor, major) и описанием сделанных изменений. Такие файлы можно создавать несколько раз в одной ветке.
3. После окончания разработки создается пул-реквест на мерж фича-ветки в ветку `develop`. При необходимости в ПР можно обновлять новыми коммитами.
4. После мержа пул-реквеста автоматически создается новая ветка `changeset-release/develop` и пул-реквест на слияние изменений из этой ветки в ветку `develop`. В этой ветке аккумулируются все созданные файлы с изменениями и на основании этих изменений обновляется версия в файле `package.json`.
5. Шаги 1-3 могут быть повторены сколько угодно раз. Пул-реквест с обновлением версии будет автоматически обновляться после каждого коммита в ветку `develop`.
6. После принятия решения об обновлении версии необходимо слить автоматически созданный ПР с веткой `develop`. Этим действием будет обновлен файл `package.json` и создан новый тег с текущей версией проекта.

#### Установка и настройка
1. Устанавливаем зависимости: 
```sh
npm i -D @changesets/cli @changesets/changelog-github
```
2. Создаем исходную конфигурацию changeset:
```sh
npx changeset init
```

3. Изменяем `.changeset/config.json` под свой проект:
```json
{
  "$schema": "https://unpkg.com/@changesets/config@2.3.1/schema.json",
  "changelog": ["@changesets/changelog-github", { "repo": "alexmyt/vc-test" }],
  "commit": false,
  "snapshot": {
    "useCalculatedVersion": true
  },
  "fixed": [],
  "linked": [],
  "ignore": [],
  "access": "restricted",
  "baseBranch": "develop",
  "updateInternalDependencies": "patch"
}
```

4. Сохранить файл `.github/workflows/changeset.yml` - эта настройка выполнения Github Action позволит автоматически запускать процесс создания и обновления PR при слиянии фича-ветки с веткой `develop`
Файл можно/нужно отредактировать в зависимости от настройки репозитория:
  - если ветка develop защищена правилами от непосредственного коммита (правило `Require a pull request before merging`), то для последнего шага необходимо [создать отдельный токен](https://github.com/settings/tokens) с правами `public_repo, repo:status, repo_deployment` и передать его через переменную окружения:
  ```yaml
        - name: Create Release Pull Request
        uses: changesets/action@v1
        with:
          commit: Version packages
          publish: npx changeset tag
        env:
          GITHUB_TOKEN: ${{ secrets.YOUR_SECRET_WITH_TOKEN }}
  ```
  - если Protection rules на ветки не используются, то можно передать стандартный `${{ secrets.GITHUB_TOKEN }}`

  5. Добавить к репозиторию [Changeset-бота](https://github.com/apps/changeset-bot) - он будет автоматически обновлять ПР с изменением версии.

  6. Опционально: для запрета пулл-реквестов без созданного файла с изменениями, можно предпринять один из шагов:
  - добавить в `.github/workflows` задачу `need-changeset.yml`, которая запускается при создании ПР из фича-ветки в ветку `develop` и запрещает ПР без созданного changeset-файла;
  - добавить хук pre-push, чтобы git делал контроль наличия changeset-файла до пуша изменений в удаленный репозиторий. В примере этот хук реализован с помощь [husky](https://github.com/typicode/husky)